name: Edge-IIoTset Quick Validation

on:
  pull_request:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      num_clients:
        description: "Number of clients"
        required: false
        default: "3"
        type: string
      num_rounds:
        description: "Number of rounds"
        required: false
        default: "5"
        type: string

permissions:
  contents: read
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quick_validation:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: pip-${{ runner.os }}-

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

      - name: Prepare Edge-IIoTset samples
        run: python scripts/setup_real_datasets.py

      - name: Run quick validation experiment
        env:
          D2_EXTENDED_METRICS: "1"
        run: |
          CLIENTS=${{ github.event.inputs.num_clients || '3' }}
          ROUNDS=${{ github.event.inputs.num_rounds || '5' }}

          echo "Starting Edge-IIoTset quick validation"
          echo "  Dimension: aggregation (FedAvg, Krum, Bulyan, Median)"
          echo "  Clients: $CLIENTS"
          echo "  Rounds: $ROUNDS"
          echo "  Dataset: edge-iiotset-quick (50k samples)"
          echo ""
          echo "System resources:"
          echo "  Memory: $(free -h | grep '^Mem:' | awk '{print $2}')"
          echo "  CPU cores: $(nproc)"
          echo "  Disk space: $(df -h . | tail -1 | awk '{print $4}')"
          echo ""

          python scripts/comparative_analysis.py \
            --dataset edge-iiotset-quick \
            --dimension aggregation \
            --output_dir results/edge_iiotset_quick \
            --num_clients "$CLIENTS" \
            --num_rounds "$ROUNDS"

      - name: Generate run-level plots
        run: |
          shopt -s nullglob
          for dir in runs/comp_*/; do
            echo "Generating plots for $dir"
            python scripts/plot_metrics.py \
              --run_dir "$dir" \
              --output_dir "$dir"
          done

      - name: Validate results
        run: |
          echo "Validating experiment results..."
          FOUND=0
          FAILED=0
          TOTAL=0

          for dir in runs/comp_*/; do
            TOTAL=$((TOTAL + 1))
            if [ -f "$dir/metrics.csv" ]; then
              echo "✓ Found metrics in $(basename $dir)"
              FOUND=$((FOUND + 1))
            else
              echo "✗ Missing metrics in $(basename $dir)"
              FAILED=$((FAILED + 1))
            fi
          done

          echo ""
          echo "VALIDATION SUMMARY:"
          echo "  Total experiments: $TOTAL"
          echo "  Successful: $FOUND"
          echo "  Failed: $FAILED"

          if [ $FOUND -eq 0 ]; then
            echo "ERROR: No experiments produced metrics"
            exit 1
          else
            echo "SUCCESS: All experiments completed"
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: edge-iiotset-quick-aggregation-${{ github.sha }}
          path: |
            runs/comp_**/metrics.csv
            runs/comp_**/client_*_metrics.csv
            runs/comp_**/config.json
            runs/comp_**/*.png
          retention-days: 30
