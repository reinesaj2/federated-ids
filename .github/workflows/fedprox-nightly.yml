name: FedProx Nightly Comparison

on:
  schedule:
    - cron: "0 2 * * *"  # 2 AM UTC daily
  workflow_dispatch:
    inputs:
      alpha_values:
        description: 'Alpha values for non-IID testing (comma-separated, e.g., "0.05,0.1,0.5")'
        required: false
        default: "0.05,0.1,0.5"
        type: string
      mu_values:
        description: 'FedProx mu values (comma-separated, e.g., "0.0,0.01,0.1")'
        required: false
        default: "0.0,0.01,0.1"
        type: string
      client_count:
        description: "Number of clients for comparison"
        required: false
        default: "10"
        type: string
      round_count:
        description: "Number of rounds for comparison"
        required: false
        default: "20"
        type: string

permissions:
  contents: read
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  fedprox_comparison:
    runs-on: ubuntu-latest
    timeout-minutes: 240  # 4 hours
    strategy:
      fail-fast: false
      matrix:
        alpha: [0.05, 0.1, 0.5]
        mu: [0.0, 0.01, 0.1]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: pip-${{ runner.os }}-

      - name: Prepare real dataset samples
        run: python scripts/setup_real_datasets.py

      - name: Install dependencies with retry
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_on: error
          command: |
            pip install -r requirements.txt
            if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

      - name: FedProx Comparison (real UNSW)
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 180
          max_attempts: 2
          retry_on: error
          command: |
            export D2_EXTENDED_METRICS="1"
            export ALPHA=${{ matrix.alpha }}
            export MU=${{ matrix.mu }}
            export ROUNDS=20
            export CLIENTS=6
            export ROUNDS=20
            export ALPHA="${{ matrix.alpha }}"
            export MU="${{ matrix.mu }}"
            PRESET="nightly_fedprox_alpha${ALPHA}_mu${MU}"
            DATASET="unsw"
            DATA_PATH="data/unsw/unsw_nb15_sample.csv"

            mkdir -p "runs/$PRESET"
            LOGDIR="runs/$PRESET"
            PORT=$((8200 + RANDOM % 1000))
            echo "$DATASET" >"$LOGDIR/dataset.txt"
            echo "$DATA_PATH" >"$LOGDIR/dataset_path.txt"
            echo "Running FedProx comparison with alpha=$ALPHA mu=$MU dataset=$DATASET"

            # Start server
            python server.py --rounds $ROUNDS --aggregation fedavg --server_address 127.0.0.1:$PORT --logdir "$LOGDIR" >"$LOGDIR/server.log" 2>&1 &
            SERVER_PID=$!
            
            # Wait for server
            for i in {1..20}; do
              nc -z 127.0.0.1 $PORT 2>/dev/null && break
              sleep 0.5
            done
            
            # Start all clients with FedProx mu parameter
            CLIENT_PIDS=()
            for CLIENT_ID in $(seq 0 $((CLIENTS-1))); do
              python client.py --server_address 127.0.0.1:$PORT --client_id $CLIENT_ID --num_clients $CLIENTS \
                --dataset "$DATASET" --data_path "$DATA_PATH" --partition_strategy dirichlet --alpha $ALPHA \
                --fedprox_mu $MU --logdir "$LOGDIR" --leakage_safe --seed 42 >"$LOGDIR/client_${CLIENT_ID}.log" 2>&1 &
              CLIENT_PIDS+=($!)
            done
            
            # Wait for all clients
            for PID in "${CLIENT_PIDS[@]}"; do
              wait $PID
            done
            
            # Clean up server
            sleep 2
            kill $SERVER_PID 2>/dev/null || true

      - name: Generate comparison plots
        run: |
          # Use same directory construction as training step
          export ALPHA="${{ matrix.alpha }}"
          export MU="${{ matrix.mu }}"
          PRESET="nightly_fedprox_alpha${ALPHA}_mu${MU}"
          RUN_DIR="runs/$PRESET"
          python scripts/plot_metrics.py \
            --run_dir "$RUN_DIR" \
            --output_dir "$RUN_DIR"
          if [ -f "$RUN_DIR/client_metrics_plot.png" ]; then
            cp "$RUN_DIR/client_metrics_plot.png" "$RUN_DIR/fedprox_comparison.png"
          fi

      - name: Validate results
        run: python scripts/ci_checks.py --runs_dir runs

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: fedprox-nightly-alpha${{ matrix.alpha }}-mu${{ matrix.mu }}-${{ github.sha }}
          path: |
            runs/**/metrics.csv
            runs/**/client_*_metrics.csv
            runs/**/fedprox_comparison.png
            runs/**/server.log
            runs/**/client_*.log
            runs/**/server_metrics_plot.png
            runs/**/client_metrics_plot.png
          retention-days: 30

  fedprox_summary:
    needs: fedprox_comparison
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install pandas matplotlib seaborn numpy

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: nightly-artifacts

      - name: Generate FedProx comparison summary
        run: |
          python scripts/analyze_fedprox_comparison.py \
            --artifacts_dir nightly-artifacts \
            --output_dir fedprox-summary

      - name: Upload consolidated results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: fedprox-nightly-summary-${{ github.sha }}
          path: |
            fedprox-summary/fedprox_comparison_summary.json
            fedprox-summary/fedprox_performance_plots.png
            fedprox-summary/fedprox_thesis_tables.tex
          retention-days: 60

  fedprox_notify:
    needs: fedprox_comparison
    runs-on: ubuntu-latest
    if: always() && needs.fedprox_comparison.result == 'failure'
    steps:
      - name: Log FedProx nightly failure
        run: |
          echo "ðŸš¨ FedProx Nightly Comparison Failed"
          echo "Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Failed at: $(date)"
          echo "Check the workflow run for details"

  manual_fedprox_comparison:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: pip-${{ runner.os }}-

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

      - name: Parse parameters and run FedProx comparison matrix
        env:
          D2_EXTENDED_METRICS: "1"
        run: |
          IFS=',' read -ra ALPHAS <<< "${{ github.event.inputs.alpha_values }}"
          IFS=',' read -ra MUS <<< "${{ github.event.inputs.mu_values }}"

          for alpha in "${ALPHAS[@]}"; do
            alpha=$(echo "$alpha" | xargs)  # trim whitespace
            for mu in "${MUS[@]}"; do
              mu=$(echo "$mu" | xargs)  # trim whitespace
              echo "Running FedProx comparison: alpha=${alpha}, mu=${mu}"

              CLIENTS=${{ github.event.inputs.client_count }}
              ROUNDS=${{ github.event.inputs.round_count }}
              PRESET="manual_fedprox_alpha${alpha}_mu${mu}"
              
              mkdir -p "runs/$PRESET"
              LOGDIR="runs/$PRESET"
              PORT=$((9200 + RANDOM % 1000))
              
              # Start server
              python server.py --rounds $ROUNDS --aggregation fedavg --server_address 127.0.0.1:$PORT --logdir "$LOGDIR" >"$LOGDIR/server.log" 2>&1 &
              SERVER_PID=$!
              
              # Wait for server
              for i in {1..20}; do
                nc -z 127.0.0.1 $PORT 2>/dev/null && break
                sleep 0.5
              done
              
              # Start all clients with FedProx mu parameter
              CLIENT_PIDS=()
              for CLIENT_ID in $(seq 0 $((CLIENTS-1))); do
                python client.py --server_address 127.0.0.1:$PORT --client_id $CLIENT_ID --num_clients $CLIENTS \
                  --dataset synthetic --samples 1000 --features 20 --partition_strategy dirichlet --alpha "$alpha" \
                  --fedprox_mu "$mu" --logdir "$LOGDIR" --leakage_safe --seed 42 >"$LOGDIR/client_${CLIENT_ID}.log" 2>&1 &
                CLIENT_PIDS+=($!)
              done
              
              # Wait for all clients
              for PID in "${CLIENT_PIDS[@]}"; do
                wait $PID
              done
              
              # Clean up server
              sleep 2
              kill $SERVER_PID 2>/dev/null || true

              python scripts/plot_metrics.py \
                --run_dir "runs/$PRESET" \
                --output_dir "runs/$PRESET"
              if [ -f "runs/$PRESET/client_metrics_plot.png" ]; then
                cp "runs/$PRESET/client_metrics_plot.png" "runs/$PRESET/comparison.png"
              fi
            done
          done

      - name: Validate all results
        run: |
          # Check that metrics files were created
          FOUND=0
          for dir in runs/*/; do
            if [ -f "$dir/metrics.csv" ]; then
              echo "âœ“ Found metrics in $(basename $dir)"
              FOUND=$((FOUND + 1))
            fi
          done
          echo "Total experiments with metrics: $FOUND"
          if [ $FOUND -eq 0 ]; then
            echo "Error: No experiments produced metrics"
            exit 1
          fi

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: manual-fedprox-comparison-${{ github.sha }}
          path: runs/**
          include-hidden-files: false
          retention-days: 14
