name: Edge-IIoTset Full-Scale Weekly

on:
  schedule:
    - cron: "0 1 * * 0" # 1 AM UTC every Sunday
  workflow_dispatch:
    inputs:
      dimension_group:
        description: "Dimension group to run (group1, group2, group3, all)"
        required: false
        default: "all"
        type: string
      num_clients:
        description: "Number of clients"
        required: false
        default: "10"
        type: string
      num_rounds:
        description: "Number of rounds"
        required: false
        default: "50"
        type: string

permissions:
  contents: write
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  full_scale_experiments:
    runs-on: ubuntu-latest
    timeout-minutes: 480 # 8 hours per dimension group
    strategy:
      fail-fast: false
      max-parallel: 3 # Run 3 groups in parallel for 24-hour total coverage
      matrix:
        include:
          - group_name: group1
            dimensions: "aggregation heterogeneity"
          - group_name: group2
            dimensions: "attack privacy"
          - group_name: group3
            dimensions: "personalization heterogeneity_fedprox"
    steps:
      - name: Determine group filter
        id: group_filter
        run: |
          if [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
            echo "should_run=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          requested_group="${{ github.event.inputs.dimension_group || 'all' }}"
          if [ "$requested_group" = "all" ]; then
            echo "should_run=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ "$requested_group" = "${{ matrix.group_name }}" ]; then
            echo "should_run=true" >> "$GITHUB_OUTPUT"
          else
            echo "should_run=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip unrequested group
        if: steps.group_filter.outputs.should_run != 'true'
        run: echo "Group ${{ matrix.group_name }} not requested; skipping job."

      - uses: actions/checkout@v4
        if: steps.group_filter.outputs.should_run == 'true'
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        if: steps.group_filter.outputs.should_run == 'true'
        with:
          python-version: "3.11"

      - uses: actions/cache@v4
        if: steps.group_filter.outputs.should_run == 'true'
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: pip-${{ runner.os }}-

      - name: Install dependencies
        if: steps.group_filter.outputs.should_run == 'true'
        run: |
          pip install -r requirements.txt
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

      - name: Prepare Edge-IIoTset samples
        if: steps.group_filter.outputs.should_run == 'true'
        run: python scripts/setup_real_datasets.py

      - name: Verify full dataset
        if: steps.group_filter.outputs.should_run == 'true'
        run: |
          FULL_DATASET="data/edge-iiotset/edge_iiotset_full.csv"
          if [ ! -f "$FULL_DATASET" ]; then
            echo "ERROR: Full-scale dataset not found at $FULL_DATASET"
            exit 1
          fi

          SIZE=$(stat -f%z "$FULL_DATASET" 2>/dev/null || stat -c%s "$FULL_DATASET" 2>/dev/null)
          echo "Full dataset size: $SIZE bytes"
          if [ $SIZE -lt 100000000 ]; then
            echo "WARNING: Dataset appears too small (< 100MB)"
          fi

      - name: Run full-scale experiments
        if: steps.group_filter.outputs.should_run == 'true'
        env:
          D2_EXTENDED_METRICS: "1"
        run: |
          CLIENTS=${{ github.event.inputs.num_clients || '10' }}
          ROUNDS=${{ github.event.inputs.num_rounds || '50' }}

          echo "=========================================="
          echo "FULL-SCALE THESIS EXPERIMENTS"
          echo "=========================================="
          echo "  Group: ${{ matrix.group_name }}"
          echo "  Dimensions: ${{ matrix.dimensions }}"
          echo "  Dataset: edge-iiotset-full (2M samples = 90% of dataset)"
          echo "  Clients: $CLIENTS"
          echo "  Rounds: $ROUNDS"
          echo ""
          echo "System resources:"
          echo "  Memory: $(free -h | grep '^Mem:' | awk '{print $2}')"
          echo "  CPU cores: $(nproc)"
          echo "  Disk space: $(df -h . | tail -1 | awk '{print $4}')"
          echo "=========================================="
          echo ""

          # Run each dimension in the group sequentially
          for dimension in ${{ matrix.dimensions }}; do
            echo ""
            echo ">>> Starting dimension: $dimension"
            echo ""

            python scripts/comparative_analysis.py \
              --dataset edge-iiotset-full \
              --dimension "$dimension" \
              --output_dir results/edge_iiotset_full \
              --num_clients "$CLIENTS" \
              --num_rounds "$ROUNDS"

            echo ""
            echo ">>> Completed dimension: $dimension"
            echo ""
          done

      - name: Generate run-level plots
        if: steps.group_filter.outputs.should_run == 'true'
        run: |
          shopt -s nullglob
          found=0
          for dir in runs/comp_*/; do
            found=1
            echo "Generating plots for $dir"
            python scripts/plot_metrics.py \
              --run_dir "$dir" \
              --output_dir "$dir"
          done

          if [ $found -eq 0 ]; then
            echo "No run directories found; skipping plot generation."
          fi

      - name: Generate thesis plots for all dimensions
        if: steps.group_filter.outputs.should_run == 'true'
        run: |
          echo "Generating thesis plots for all dimensions in runs/"

          # Check if we have experiment data
          shopt -s nullglob
          run_dirs=(runs/comp_*/)
          if [ ! -d "runs" ] || [ ${#run_dirs[@]} -eq 0 ]; then
            echo "ERROR: No experiment data found in runs/ directory"
            exit 1
          fi

          # Generate comprehensive plots for all available data
          python scripts/generate_thesis_plots.py \
            --dimension all \
            --runs_dir runs \
            --output_dir results/thesis_plots/edge_iiotset_full

          # Verify plots were generated
          if [ -d "results/thesis_plots/edge_iiotset_full" ]; then
            PLOT_COUNT=$(find results/thesis_plots/edge_iiotset_full -name "*.png" -o -name "*.pdf" | wc -l)
            echo "Generated $PLOT_COUNT thesis-quality plots"

            # List all generated plots
            echo ""
            echo "Generated plots:"
            find results/thesis_plots/edge_iiotset_full -name "*.png" -o -name "*.pdf" | sort
          else
            echo "ERROR: No plots generated"
            exit 1
          fi

      - name: Validate results
        if: steps.group_filter.outputs.should_run == 'true'
        run: |
          echo "Validating experiment results..."
          FOUND=0
          FAILED=0
          TOTAL=0

          for dir in runs/comp_*/; do
            TOTAL=$((TOTAL + 1))
            if [ -f "$dir/metrics.csv" ]; then
              ROWS=$(wc -l < "$dir/metrics.csv")
              echo "✓ $(basename $dir): $ROWS rows"
              FOUND=$((FOUND + 1))
            else
              echo "✗ $(basename $dir): NO METRICS"
              FAILED=$((FAILED + 1))
            fi
          done

          echo ""
          echo "=========================================="
          echo "VALIDATION SUMMARY - ${{ matrix.group_name }}"
          echo "=========================================="
          echo "  Total experiments: $TOTAL"
          echo "  Successful: $FOUND"
          echo "  Failed: $FAILED"
          echo "  Success rate: $((FOUND * 100 / TOTAL))%"
          echo "=========================================="

          # Require at least 50% success rate
          if [ $FOUND -eq 0 ]; then
            echo "CRITICAL ERROR: No experiments produced metrics"
            exit 1
          elif [ $FOUND -lt $((TOTAL / 2)) ]; then
            echo "WARNING: Low success rate, but continuing..."
          else
            echo "SUCCESS: All experiments completed successfully"
          fi

      - uses: actions/upload-artifact@v4
        if: steps.group_filter.outputs.should_run == 'true'
        with:
          name: edge-iiotset-full-${{ matrix.group_name }}-${{ github.sha }}
          path: |
            runs/comp_**/metrics.csv
            runs/comp_**/client_*_metrics.csv
            runs/comp_**/config.json
            runs/comp_**/*.log
            results/thesis_plots/edge_iiotset_full/**/*.png
            results/thesis_plots/edge_iiotset_full/**/*.pdf
          retention-days: 365 # Keep thesis results for 1 year

  consolidated_summary:
    needs: full_scale_experiments
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install pandas matplotlib seaborn numpy scipy

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: edge-iiotset-full-artifacts

      - name: Generate consolidated thesis summary
        run: |
          mkdir -p edge-iiotset-full-thesis-summary

          # Collect all thesis plots from all groups
          find edge-iiotset-full-artifacts -type f \( -name "*.png" -o -name "*.pdf" \) | while read file; do
            cp "$file" edge-iiotset-full-thesis-summary/
          done

          # Count plots
          PNG_COUNT=$(find edge-iiotset-full-thesis-summary -name "*.png" | wc -l)
          PDF_COUNT=$(find edge-iiotset-full-thesis-summary -name "*.pdf" | wc -l)

          # Create comprehensive markdown index
          cat > edge-iiotset-full-thesis-summary/README.md << EOF
          # Edge-IIoTset Full-Scale Thesis Results

          Publication-quality plots from 2M sample experiments (90% of dataset)

          **Generated:** $(date)
          **PNG Plots:** $PNG_COUNT
          **PDF Plots:** $PDF_COUNT

          ## Experiment Configuration

          - **Dataset:** Edge-IIoTset Full (2,000,000 samples)
          - **Clients:** 10
          - **Rounds:** 50
          - **Dimensions:** All 6 thesis dimensions

          ## Available Plots by Dimension

          EOF

          for dim in aggregation heterogeneity heterogeneity_fedprox attack privacy personalization; do
            echo "### $dim" >> edge-iiotset-full-thesis-summary/README.md
            echo "" >> edge-iiotset-full-thesis-summary/README.md
            find edge-iiotset-full-thesis-summary -name "*${dim}*.png" | while read plot; do
              echo "- ![$(basename $plot)]($(basename $plot))" >> edge-iiotset-full-thesis-summary/README.md
            done
            echo "" >> edge-iiotset-full-thesis-summary/README.md
          done

          echo "## Artifact Contents" >> edge-iiotset-full-thesis-summary/README.md
          echo "" >> edge-iiotset-full-thesis-summary/README.md
          echo "All plots are available in both PNG (300 DPI) and PDF (vector) formats for thesis publication." >> edge-iiotset-full-thesis-summary/README.md

      - name: Upload consolidated results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: edge-iiotset-full-thesis-plots-${{ github.sha }}
          path: edge-iiotset-full-thesis-summary/**
          retention-days: 365

  commit_thesis_plots:
    needs: [consolidated_summary]
    runs-on: ubuntu-latest
    if: always() && needs.consolidated_summary.result == 'success'
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Download consolidated results
        uses: actions/download-artifact@v4
        with:
          name: edge-iiotset-full-thesis-plots-${{ github.sha }}
          path: edge-iiotset-full-thesis-summary

      - name: Commit plots to repository
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          mkdir -p plots/thesis

          # Copy Edge-IIoTset full-scale plots
          if [ -d "edge-iiotset-full-thesis-summary" ]; then
            python scripts/commit_plots.py \
              --source_dir edge-iiotset-full-thesis-summary \
              --experiment_type edge-iiotset-full \
              --plots_dir plots/thesis

            echo ""
            echo "Committed plots to plots/thesis/$(date +%Y-%m-%d)/edge-iiotset-full/"
          fi

      - name: Push plots to repository
        run: |
          if git log origin/main..HEAD --oneline | grep -q .; then
            echo "Pushing thesis plots to main branch..."
            git push origin main
            echo "✓ Plots committed and pushed successfully"
          else
            echo "No new commits to push"
          fi

  notify_completion:
    needs: [commit_thesis_plots]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Log completion status
        run: |
          echo "=========================================="
          echo "FULL-SCALE WEEKLY RUN COMPLETE"
          echo "=========================================="
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Status: ${{ needs.commit_thesis_plots.result }}"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Completed: $(date)"
          echo "=========================================="
          echo ""
          echo "View results:"
          echo "  Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "  Committed Plots: ${{ github.server_url }}/${{ github.repository }}/tree/main/plots/thesis"
